# Box-c version 3 to 5 Migration Utility
#### To build:
`mvn clean install`
or
`mvn package -pl migration-util`

#### Usage:
Using the wrapper script:
`sudo dcr_migr.sh`
or direct invocation:
`java -jar migration-util/target/dcr-migration-util.jar`

#### To debug the built jar:
`java -Xdebug -Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=y -jar migration-util/target/dcr-migration-util.jar`

#### Bulk transforming PREMIS
Transforming deposit record PREMIS
`dcr_migr.sh transform_premis -d /path/to/premis_transform/deposit_list.txt /path/to/premis_transform/deposit_out/`

## Populating path index
First, you need to generate lists of all object and datastream files:
```
sudo tree -fFi  /path/to/home/fedora/objects/ | ack --nopager -v "/$" > /tmp/bxc_objects.txt &
sudo tree -fFi  /path/to/home/fedora/datastreams/ | ack --nopager -v "/$" > /tmp/bxc_datastreams.txt &
```
This will take a long time.

Note: for the following commands you can specify the destination where the index database should be stored by setting the `dcr.migration.index.url` system property.

Next, populate the path index (<10 minutes):
```
dcr_migr.sh path_index populate /tmp/bxc_objects.txt /tmp/bxc_datastreams.txt
```

You can now query the index:
```
# Count the number of files indexed
`dcr_migr.sh path_index count`

# Get all the paths for a uuid
`dcr_migr.sh path_index get_paths <uuid>`
	
# List all paths for multiple uuids
`dcr_migr.sh path_index list_paths <list file>`
### the result could then be used to pull files
for file in $(</tmp/pull_list.txt); do cp "$file" /path/to/dest; done
```

## Transform a tree of content objects
```
dcr_migr.sh transform_content <id of top level object to transform>
```

## Retrieve generate deposit model in turtle format
`dcr_migr.sh view_deposit_model <deposit id> -t`
  
## Querying the deposit model
The following will query the deposit model for "dd825c2f-6ea3-4ed7-ba68-3182f02c9fe6" for all file objects which don't have storageUris:
```
echo "select ?pid where { ?pid <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://cdr.unc.edu/definitions/model#FileObject> . FILTER NOT EXISTS { ?pid <http://cdr.unc.edu/definitions/deposit#storageUri> ?uri }}" | sudo dcr_migr.sh vdm dd825c2f-6ea3-4ed7-ba68-3182f02c9fe6 -q @-
```
The query can also be read from a file by giving a file path for the -q option

## Updating the deposit model
You can also run sparql update queries against a deposit model. The following adds a property to each FileObject in a model, based off a list of ids from a file:

```
while read p; do
  p=${p%$'\n'}
  p=${p%$'\r'}
  echo "insert { <http://dcr-test-bes.libint.unc.edu:8181/fcrepo/rest/content/$p> <http://cdr.unc.edu/definitions/deposit#storageUri> \"file:///mnt/external_test/smb_pre_storage/$p/datafs/original_file\" } WHERE {}" | sudo dcr_migr.sh um dd825c2f-6ea3-4ed7-ba68-3182f02c9fe6 @-
done < /tmp/missing_storage.txt
```
  
## Transforming Content
Basic usage, which will transform the content into a deposit in the deposit directory, and return the identifier of the deposit:
`sudo dcr_migr.sh transform_content <id of top level object to transform>`

To perform a transform and immediately submit the generated deposit for ingest into a destination container:
`sudo dcr_migr.sh transform_content <id of top level object to transform> -g --deposit-into <id of destination>`

For testing purposes, objects can be transformed to have new IDs rather than carrying over the IDs from bxc3 by including the `-g` flag.

## Submitting for deposit
Once a content deposit has been generated by the transform command, it can be submitted using the following:
`sudo dcr_migr.sh submit_deposit <deposit id> <id of destination>`
  
## Requeuing failed services
To move failed enhancement messages from the DLQ back to the enhancement queue:
`sudo dcr_migr.sh dlq requeue_enhancements`